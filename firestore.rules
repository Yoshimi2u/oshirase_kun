rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザードキュメント（FCMトークン・通知設定・プロフィール保存用）
    match /users/{userId} {
      // 読み取り: 自分のデータのみ、またはグループメンバーが表示名を取得する場合
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // 書き込み: 自分のデータのみ（FCMトークン・通知設定・プロフィールの更新用）
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && (!request.resource.data.keys().hasAny(['displayName']) 
                       || (request.resource.data.displayName is string 
                           && request.resource.data.displayName.size() <= 20));
      
      // ユーザーの設定（通知設定など）
      match /settings/{settingId} {
        // 読み取り: 自分の設定のみ
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // 書き込み: 自分の設定のみ
        allow write: if request.auth != null 
                     && request.auth.uid == userId
                     && (settingId != 'notifications' 
                         || (request.resource.data.keys().hasAll([
                              'morningEnabled',
                              'morningHour',
                              'eveningEnabled',
                              'eveningHour'
                            ])
                            && request.resource.data.morningEnabled is bool
                            && request.resource.data.morningHour is int
                            && request.resource.data.morningHour >= 0
                            && request.resource.data.morningHour <= 23
                            && request.resource.data.eveningEnabled is bool
                            && request.resource.data.eveningHour is int
                            && request.resource.data.eveningHour >= 0
                            && request.resource.data.eveningHour <= 23));
      }
      
      // バックアップメタデータ
      match /backups/{backupId} {
        // 読み取り: 自分のバックアップのみ
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // 作成: 自分のバックアップのみ
        allow create: if request.auth != null && request.auth.uid == userId;
        
        // 削除: 自分のバックアップのみ
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // ユーザーごとの予定データ
    // 認証済みユーザーが自分のデータのみ読み書き可能
    // グループ予定の場合はグループメンバー全員がアクセス可能
    match /users/{userId}/schedules/{scheduleId} {
      // グループ予定かどうかを判定するヘルパー関数
      function isGroupSchedule() {
        return resource.data.isGroupSchedule == true 
               && resource.data.groupId != null;
      }
      
      // グループメンバーかどうかを確認
      function isGroupMember(groupId) {
        return request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.memberIds;
      }
      
      // 読み取り: 自分の予定 または グループ予定でメンバーの場合
      allow read: if request.auth != null 
                  && (request.auth.uid == userId 
                      || (isGroupSchedule() && isGroupMember(resource.data.groupId)));
      
      // 作成時のバリデーション
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    && request.resource.data.keys().hasAll([
                      'title', 
                      'description', 
                      'repeatType',
                      'isActive',
                      'requiresCompletion',
                      'createdAt',
                      'updatedAt'
                    ])
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 0
                    && request.resource.data.description is string
                    && request.resource.data.isActive is bool
                    && request.resource.data.requiresCompletion is bool
                    && request.resource.data.createdAt is timestamp
                    && request.resource.data.updatedAt is timestamp;
      
      // 更新: 自分の予定 または グループ予定でメンバーの場合
      allow update: if request.auth != null 
                    && (request.auth.uid == userId 
                        || (isGroupSchedule() && isGroupMember(resource.data.groupId)))
                    && request.resource.data.title is string
                    && request.resource.data.title.size() > 0
                    && request.resource.data.updatedAt is timestamp
                    // createdAtは変更不可
                    && request.resource.data.createdAt == resource.data.createdAt;
      
      // 削除: 自分の予定 または グループ予定でメンバーの場合
      allow delete: if request.auth != null 
                    && (request.auth.uid == userId 
                        || (isGroupSchedule() && isGroupMember(resource.data.groupId)));
    }
    
    // グループデータ
    match /groups/{groupId} {
      // グループの読み取り: メンバーのみ
      allow read: if request.auth != null 
                  && request.auth.uid in resource.data.memberIds;
      
      // グループの作成: 認証済みユーザーが自分をオーナーとして作成
      allow create: if request.auth != null
                    && request.auth.uid == request.resource.data.ownerId
                    && request.auth.uid in request.resource.data.memberIds
                    && request.resource.data.keys().hasAll([
                      'name',
                      'inviteCode',
                      'ownerId',
                      'memberIds',
                      'isActive',
                      'createdAt',
                      'updatedAt'
                    ])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.inviteCode is string
                    && request.resource.data.inviteCode.size() == 6
                    && request.resource.data.memberIds is list
                    && request.resource.data.memberIds.size() > 0
                    && request.resource.data.isActive is bool
                    && request.resource.data.createdAt is timestamp
                    && request.resource.data.updatedAt is timestamp;
      
      // グループの更新: メンバーのみ（メンバー追加・削除、名前変更）
      allow update: if request.auth != null
                    && request.auth.uid in resource.data.memberIds
                    // オーナーは変更不可
                    && request.resource.data.ownerId == resource.data.ownerId
                    // 招待コードは変更不可
                    && request.resource.data.inviteCode == resource.data.inviteCode;
      
      // グループの削除: オーナーのみ
      allow delete: if request.auth != null
                    && request.auth.uid == resource.data.ownerId;
    }
    
    // その他のドキュメントへのアクセスは拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
